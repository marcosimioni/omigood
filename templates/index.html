<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css">
    <style media="screen">
      .wrapper {
        padding: 2rem 3%;
      }

      .bx--form-item {
        margin-bottom: 1.5rem;
      }

      .warning {
        color: orange;
      }
      .error {
        color: red;
      }
      .info {
        color: black;
      }
    </style>
  </head>
  <body>
    <form id="the-form">
      <div class="wrapper" style="background: white;">
        <div class="bx--form-item">
            <p><b>OMIGOD! OM I GOOD??</b></p>
            <p>
              The Wiz threat research team recently found four critical vulnerabilities in OMI, which is one of Azure's most ubiquitous yet least known software agents and is automatically deployed on a large portion of Linux VMs in Azure.
            </p>
            <p>
              The vulnerabilities are very easy to exploit and one of them (CVE-2021-38647), may allow attackers to remotely execute arbitrary code remotely with root privileges.
            </p>
            <p>
              For more information, please visit the <a href="https://www.wiz.io/blog/omigod-critical-vulnerabilities-in-omi-azure">blog post</a> published by the Wiz threat research as well as the <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647">update guide</a> released by Microsoft.
            </p>
            <p>
              Please note this page and its associated tools are not affiliated with Wix nor Microsoft.
            </p>
            <p>
              It has already been reported that this vulnerability is being exploited in the wild. Organizations should quickly patch your Linux VMs on Azure if they are exposing the OMI service over HTTP/HTTPS. As it might be difficult to quickly determine which machines are at risk in your organization, we developed a few tools to help.
            </p>
            <p>
              First, this web page, that will check, given an IP address or hostname, whether the OMI server is listening on ports 1270,5985,5986. It will try to connect to the machine and execute a command (id) to test whether the system is vulnerable: we are not storing any logs of the machines scanned.
            </p>
            <p>
              We also released <a href="https://github.com/marcosimioni/omigood">OM I Good?</a>, a simple yet powerful python script that uses Azure APIs  to enumerate your Linux VMs report whether they might be vulnerable.
            </p>
            <p>
              For questions, please open an issue on GitHub.
            </p>
        </div>
        <div class="bx--form-item">
            <p>
              If you want to know if your Linux VM is vulnerable from the Internet, enter the IP address or host name below and press the "Check now" button.
            </p>
        </div>
        <div class="bx--form-item">
          <input id="fqdn" name="fqdn" type="text" class="bx--text-input" placeholder="www.myazurebox.com">
          <label for="fqdn" class="bx--label">Please enter the FQDN or IP address that you want to check</label>
        </div>
        <div class="bx--form-item">
          {{ recaptcha }} <!-- Refer to 'recaptcha' variable in main.py -->
        </div>
        <div class="bx--form-item">
          <button id="check" class="bx--btn bx--btn--primary" type="button">Check now</button>
        </div>
        <div id="checking" style="display: none;">
          <div aria-atomic="true" aria-labelledby="loading-id-3" aria-live="assertive" class="bx--loading bx--loading--small"><label id="loading-id-3" class="bx--visually-hidden">Active loading indicator</label><svg class="bx--loading__svg" viewBox="0 0 100 100"><title>Active loading indicator</title><circle class="bx--loading__background" cx="50%" cy="50%" r="44"></circle><circle class="bx--loading__stroke" cx="50%" cy="50%" r="44"></circle></svg></div>
        </div>
        <div id="result" style="display: none;">
          <p class="info">
            This is the check result.
          </p>
        </div>
      </div>
    </form>
    <script>
      function disableSubmit() {
        $("#check").prop('disabled',true);
      }
      function enableSubmit() {
        $("#check").prop('disabled',false);
      }
      function showChecking() {
        $("#checking").show();
      }
      function hideChecking() {
        $("#checking").hide();
      }
      function updateResult(type,text) {
        $("#result p").removeClass('error warning info').addClass(type);
        $("#result p").text(text);
      }
      function showResult() {
        $("#result").show();
      }
      function hideResult() {
        $("#result").hide();
      }
      function resetCaptcha() {
        grecaptcha.reset();
      }
      function preChecking() {
        disableSubmit();
        hideResult();
        showChecking();
      }
      function postChecking() {
        hideChecking();
        showResult();
        enableSubmit();
        resetCaptcha();
      }
      function isValidFQDN(fqdn) {
        return true;
      }
      function isCaptchaChecked() {
        return grecaptcha && grecaptcha.getResponse().length !== 0;
      }

      function checkFQDN(fqdn, callback) {
        $.ajax({
            url : '/check',
            type : 'POST',
            data : $('form#the-form').serialize(),
            dataType : 'json',
            success : function(data) {
              if (data) {
                callback(data.result, data.fqdn, data.report);
              } else {
                callback(GENERIC_ERROR, fqdn, 0);
              }
            },
            error : function(request,error) {
                callback(GENERIC_ERROR, fqdn, 0);
            }
        });
      }

      $("#check").click(function() {
        if (!isCaptchaChecked()) {
          updateResult('error',`Please prove that you are not a robot.`);
          return;
        }

        fqdn = $("#fqdn").val();
        if (!isValidFQDN(fqdn)) {
          updateResult('error',`Invalid fqdn provided: please enter a hostname or an IP address.`);
          return;
        }

        preChecking();
        checkFQDN(fqdn, function (result, fqdn, report) {

          // error code
          CHECK_SUCCESSFUL = 0;
          GENERIC_ERROR = -1;
          FQDN_NOT_PROVIDED = -2;
          INVALID_FQDN = -3;
          CAPTCHA_ERROR = -999;

          // port status
          DONT_KNOW = 0;
          OMI_EXPOSED_BUT_NOT_VULNERABLE = 1;
          OMI_EXPOSED_AND_VULNERABLE = 2;

          switch (result) {
            case GENERIC_ERROR:
              updateResult('error',`A generic error occurred.`);
              break;

            case FQDN_NOT_PROVIDED:
              updateResult('error',`An fqdn was not provided.`);
              break;

            case INVALID_FQDN:
              updateResult('error',`An invalid fqdn was provide.`);
              break;

            case CAPTCHA_ERROR:
              updateResult('error',`Please prove that you are not a robot.`);
              break;

            case CHECK_SUCCESSFUL:
              vulnerable_ports = "";
              listening_ports = "";
              for (var key in report) {
                  if (report.hasOwnProperty(key)) {
                      vuln = report[key];
                      if (vuln == OMI_EXPOSED_BUT_NOT_VULNERABLE) {
                        listening_ports=vulnerable_ports+","+key
                      } else if (vuln == OMI_EXPOSED_AND_VULNERABLE) {
                        vulnerable_ports=vulnerable_ports+","+key
                      }
                  }
              }

              if (vulnerable_ports != "") {
                updateResult('error',`Your machine ${fqdn} exposes a vulnerable version of OMI on port(s) ${vulnerable_ports.substring(1)}: it is recommended to patch immediately and also review your Network Security Group, unless you have a good reason to not do so and you know what you are doing. Please check the official guidance available at the resources linked above.`);
              } else if (listening_ports != "") {
                updateResult('error',`Your machine ${fqdn} exposes OMI on port(s) ${listening_ports.substring(1)} but it is not vulnerable: it is recommended to review your Network Security Group, unless you have a good reason to not do so and you know what you are doing.`);
              } else {
                updateResult('info',`Your machine ${fqdn} is not reachable or does not expose OMI on any port.`);
              }
              break;

            default: // don't known
              updateResult('error',`A generic error occurred.`);
              break;
          }
          postChecking();
        });
      });
    </script>
  </body>
</html>
